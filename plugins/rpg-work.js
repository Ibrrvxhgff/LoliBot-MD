import { db } from '../lib/postgres.js';

// قائمة الأعمال العشوائية باللغة العربية
const work_arabic = [
    'أنت خيميائي بارع، تقوم بتقطير الجرعات الغامضة بحثًا عن الأسرار المفقودة. تحصل على:',
    'أنت صياد كنوز مقدام، تستكشف الأماكن المنسية بحثًا عن الثروات المخفية. تحصل على:',
    'تساعد في الإشراف على إحدى مجموعات البوت. تحصل على:',
    'تعمل لصالح شركة عسكرية خاصة وتكسب:',
    'تنظم حدثًا لتذوق أفضل أنواع القهوة وتكسب:',
    'تستكشف أطلالًا قديمة وتجد قطعة أثرية ثمينة تمنحك حكمة الأجداد. تكسب:',
    'تعمل كمرتزق في حرب ملحمية، وتواجه التحديات بمهارتك وشجاعتك. تكسب:',
    'أنت باحث في الظواهر الخارقة، وتكشف أسرار العالم الروحي الخفية. تحصل على:',
    'تقوم بتدريب التنانين للمشاركة في سباقات، وتكوّن روابط قوية مع هذه المخلوقات المهيبة. تكسب:',
    'أصبحت أفضل حداد في المدينة، تصنع أسلحة أسطورية وقطعًا أثرية قوية. تكسب:',
    'تسافر عبر الزمن وتحل المشاكل التاريخية، وتؤثر في مصير الحضارات. تكسب:',
    'أنت مستشار ملكي، تقدم الحكمة والمشورة للحكام والقادة. تكسب:',
    'تطور تكنولوجيا مستقبلية، وتدفع بالابتكار وتغير مسار العالم. تكسب:',
    'أنت خبير في فن الإقناع، وتقنع الآخرين ببلاغتك ودهائك. تكسب:',
    'تقود روبوتًا عملاقًا في معارك ملحمية، وتدافع عن الأرض ببراعتك. تكسب:',
    'أنت جاسوس دولي، تتسلل إلى منظمات سرية وتكشف مؤامرات خطيرة. تكسب:',
    'تستكشف الفضاء وتقوم باكتشافات مذهلة تمنحك رؤية فريدة للكون. تكسب:',
    'أنت ساحر مشهور، تؤدي خدعًا مدهشة وتستحضر تعويذات سحرية. تكسب:',
    'أنت عالم مجنون، تخترع اختراعات غريبة وتجري تجارب غير عادية. تكسب:',
    'تدافع عن المملكة ضد جيش غازٍ، وتقود الجيوش وتظهر شجاعتك في المعركة. تكسب:',
    'أنت طاهٍ مشهور، تبدع أطباقًا لذيذة تسعد الأذواق في جميع أنحاء العالم. تكسب:',
    'تحقق في جرائم معقدة كمحقق ماهر، وتحل ألغازًا مثيرة. تكسب:',
    'أنت دبلوماسي ماهر، تتفاوض على المعاهدات والتحالفات للحفاظ على السلام. تكسب:',
    'تكتشف علاجًا لمرض فتاك، وتنقذ عددًا لا يحصى من الأرواح. تكسب:',
    'أنت مخترق حواسيب (هاكر)، تتنقل في الفضاء الإلكتروني وتكشف الأسرار الرقمية. تكسب:',
    'أنت عالم آثار تكتشف مدينة قديمة، وتكشف أسرار الحضارات الماضية. تكسب:',
    'أنت لاعب محترف، تتنافس في بطولات النخبة وتثبت مهارتك في الألعاب. تكسب:'
];

// دالة لتحويل الميلي ثانية إلى دقائق وثواني
function msToTime(duration) {
    const totalSeconds = Math.floor(duration / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${minutes} دقيقة و ${seconds} ثانية`;
}

// دالة لاختيار عنصر عشوائي من القائمة
function pickRandom(list) {
    return list[Math.floor(Math.random() * list.length)];
}

// دالة لتنسيق الأرقام
function formatNumber(num) {
    return num.toLocaleString('en-US');
}

const handler = async (m, { conn, usedPrefix }) => {
    const cooldown = 600000; // 10 دقائق
    const now = Date.now();

    try {
        const res = await db.query('SELECT exp, lastwork FROM usuarios WHERE id = $1', [m.sender]);
        const user = res.rows[0];

        if (!user) {
            return m.reply(`⚠️ أنت غير مسجل. استخدم الأمر \`${usedPrefix}تسجيل\` للبدء.`);
        }

        const lastWork = Number(user.lastwork) || 0;
        const remaining = Math.max(0, lastWork + cooldown - now);

        if (remaining > 0) {
            return conn.reply(m.chat, `*⏳ يجب أن ترتاح لمدة ${msToTime(remaining)} قبل أن تتمكن من العمل مرة أخرى.*`, m);
        }

        const xpGained = Math.floor(Math.random() * 6500) + 500; // ربح بين 500 و 7000
        await db.query(`UPDATE usuarios SET exp = exp + $1, lastwork = $2 WHERE id = $3`, [xpGained, now, m.sender]);

        await conn.reply(m.chat, `*${pickRandom(work_arabic)}* *${formatNumber(xpGained)}* ✨خبرة`, m);

    } catch (e) {
        console.error('Work command error:', e);
        m.reply('❌ حدث خطأ أثناء محاولة العمل. يرجى المحاولة مرة أخرى.');
    }
};

handler.help = ['عمل', 'شغل'];
handler.tags = ['economy'];
handler.command = /^(work|trabajar|chambear|w|chamba|عمل|شغل|اعمل)$/i;
handler.register = true;

export default handler;
